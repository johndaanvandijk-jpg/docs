IoTStruktur: ESP32-Wetterstation – Von der Messung bis zum Graphen

1) Verständliche Ablaufbeschreibung (End-to-End)

Kurzüberblick
- Hardware: ESP32 + DHT11 (Temperatur/Feuchte an GPIO4) + Solarmessung (Analog an GPIO34, mit Spannungsteiler) + OLED (I2C, 128x64)
- Netzwerk: ESP32 erstellt einen eigenen WLAN-Hotspot (SoftAP) mit Name „Wetterstation von John“ und Passwort „nwtprojekt“
- Webserver: Läuft auf dem ESP32 (Port 80). Stellt Webseite, Daten (JSON), CSV-Download und Verwaltungsfunktionen bereit
- Speicher: LittleFS-Dateisystem auf dem ESP32. Speichert Messprotokoll in /data.csv und statische Dateien wie chart.js
- Frontend: Einfache HTML-Seite mit Chart.js, holt alle 2 Sekunden neue Messwerte vom ESP32 und zeichnet sie als Liniendiagramm

Schritt für Schritt
1. Start/Setup des Geräts
   - Sensoren und Display werden initialisiert (DHT11, OLED)
   - ESP32 startet als WLAN-Access-Point (Hotspot). Die IP-Adresse (z. B. 192.168.4.1) wird auf dem OLED angezeigt
   - LittleFS wird gemountet (interner Speicher für Dateien)
   - HTTP-Routen werden registriert und der Webserver gestartet

2. Messen (Live alle 2 Sekunden)
   - Alle 2 s liest der ESP32 den DHT11: Temperatur (t) und Luftfeuchtigkeit (h)
   - Gleichzeitig wird der ADC-Wert der Solarspannung (GPIO34) gelesen und in Volt umgerechnet:
     solarV = (analogRaw/4095) * 3.3V * 2  (Faktor 2 wegen Spannungsteiler)
   - Die aktuellen Werte werden in globalen Variablen abgelegt und auf dem OLED angezeigt

3. Langzeitprotokoll (alle 5 Minuten)
   - Alle 300.000 ms (5 min) schreibt der ESP32 eine neue Zeile in /data.csv
   - Format: sekSeitStart,Temperatur,Feuchte,Solar (eine Zeile pro Eintrag)
   - Beispiel: 12345,21.4,52.0,1.65

4. Daten bereitstellen (HTTP-Routen)
   - /          -> Liefert die HTML-Startseite (index_html, eingebettet im Programm)
   - /data      -> Liefert die aktuellen Live-Werte als JSON: {"temperature":t, "humidity":h, "solar":solarV}
   - /download  -> Streamt die gespeicherte CSV-Datei /data.csv
   - /clear     -> Löscht /data.csv (setzt das Log zurück)
   - /upload    -> Einfache Wartungsseite zum Hochladen von Dateien ins LittleFS (z. B. chart.js)
   - /chart.js  -> Liefert Chart.js aus dem LittleFS

5. Browser/Frontend – „User sieht Graphen“
   - Nutzer verbindet sich mit dem Hotspot des ESP32 und öffnet die im OLED angezeigte IP im Browser
   - Die HTML-Seite lädt Chart.js und initialisiert ein Liniendiagramm mit 3 Kurven: Temperatur, Solarspannung, Luftfeuchtigkeit
   - Ein JavaScript-Timer ruft alle 2 Sekunden /data auf, aktualisiert die Zahlenanzeigen und fügt neue Punkte ins Diagramm ein
   - Es wird ein Ringpuffer genutzt: Über 50 Punkte hinaus werden alte Einträge entfernt, damit das Diagramm flüssig bleibt
   - Buttons: „Daten als CSV speichern“ lädt /download herunter, „Messung neu starten“ ruft /clear auf und lädt die Seite neu

Datenfluss (gedankliches Bild)
- Sensoren (DHT11, ADC) -> ESP32 misst -> Werte in Variablen -> Webserver gibt /data (JSON) -> Browser holt /data -> Chart.js zeichnet Graph
- Parallel: ESP32 schreibt alle 5 min eine Zeile nach /data.csv -> /download liefert diese Datei an den Browser

Wichtige Begriffe kurz erklärt
- SoftAP: Der ESP32 erstellt selbst ein WLAN, mit dem sich das Handy/Notebook verbinden kann
- LittleFS: Kleines Dateisystem im Flash des ESP32, speichert z. B. data.csv oder chart.js
- JSON: Einfaches Textformat für Daten (Schlüssel:Wert), ideal für Browser-APIs
- Chart.js: JavaScript-Bibliothek, die Diagramme im Browser zeichnet
- Ringpuffer: Liste mit fester Maximalgröße; wenn sie voll ist, wird vorne gelöscht und hinten ein neuer Wert angehängt
- ADC/Spannungsteiler: Analog-Digital-Wandler misst eine Spannung; mit Widerständen wird die Eingangsspannung auf messbaren Bereich geteilt


2) Abstrakte Darstellung der Codeabläufe (für Einsteiger)

A. setup() – einmal beim Start
- Starte serielle Ausgabe (Debug)
- Starte Sensoren (DHT11), Display (OLED)
- Zeige „Starte Hotspot…“ an
- Erzeuge WLAN-Hotspot (Name + Passwort), merke dir die zugehörige IP-Adresse
- Starte LittleFS (interner Speicher)
- Lege Webserver-Routen fest:
  - "/": liefere die Startseite (HTML)
  - "/data": liefere aktuelle Messwerte als JSON
  - "/download": liefere /data.csv zum Herunterladen
  - "/clear": lösche /data.csv
  - "/upload" (GET/POST): kleiner Dateiupload (Wartung)
  - "/chart.js": liefere Chart.js aus dem Speicher
- Starte den Webserver
- Zeige auf dem OLED: WLAN-Name und IP-Adresse

B. loop() – läuft unendlich oft
- server.handleClient(): beantworte eingehende HTTP-Anfragen (Browser)
- Alle 2 s (Timer 1):
  - Messe h = Luftfeuchte, t = Temperatur (nur wenn gültige Werte)
  - Messe solarV = umgerechnete Solarspannung
  - Zeige IP, t, h, solarV auf dem OLED an
- Alle 5 min (Timer 2):
  - Öffne /data.csv im Anhänge-Modus
  - Schreibe: sekSeitStart, t, h, solarV in eine neue Zeile
  - Schließe Datei

C. API-Antworten (vereinfacht)
- /data -> "{ temperature: t, humidity: h, solar: solarV }"
- /download -> Inhalt der Datei /data.csv
- /clear -> löscht /data.csv
- / -> HTML-Seite mit eingebettetem JavaScript (nutzt Chart.js)
- /chart.js -> statische Bibliothek für Diagramme

D. Browser-Logik (vereinfacht)
- Beim Laden der Seite:
  - Erzeuge ein leeres Liniendiagramm (Chart.js)
- Alle 2 s:
  - rufe /data auf
  - aktualisiere Textfelder (Temperatur, Feuchte, Solar)
  - hänge Zeitstempel und Messwerte ans Diagramm an
  - wenn mehr als 50 Punkte: entferne den ältesten Punkt (Ringpuffer)
  - Diagramm neu zeichnen
- Buttons:
  - Download -> lade /download (CSV-Datei)
  - Reset -> rufe /clear auf, dann Seite neu laden

E. Typische Anpassungen (Ideen)
- Messintervall ändern (z. B. 1 s statt 2 s)
- Logintervall ändern (z. B. 60 s statt 300 s zum Testen)
- Weitere Sensoren hinzufügen und im JSON + Diagramm anzeigen
- Statt eigenem Hotspot: mit Heim-WLAN verbinden und IP im Router nachsehen
- CSV um Datum/Uhrzeit ergänzen (RTC oder NTP), statt „Sekunden seit Start“

Praxis: So benutzt du es
- Verbinde dein Gerät (Handy/Laptop) mit dem WLAN „Wetterstation von John“ (Passwort: nwtprojekt)
- Öffne im Browser die IP, die auf dem OLED angezeigt wird (häufig 192.168.4.1)
- Beobachte Live-Werte und den Graphen; speichere bei Bedarf die CSV
